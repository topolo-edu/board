<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="io.goorm.board.mapper.CategoryMapper">

    <!-- CategoryDto ResultMap -->
    <resultMap id="categoryDtoResultMap" type="io.goorm.board.dto.category.CategoryDto">
        <id property="categorySeq" column="category_seq"/>
        <result property="name" column="name"/>
        <result property="description" column="description"/>
        <result property="sortOrder" column="sort_order"/>
        <result property="isActive" column="is_active"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
        <result property="createdSeq" column="created_seq"/>
        <result property="updatedSeq" column="updated_seq"/>
    </resultMap>

    <!-- 기본 컬럼 -->
    <sql id="categoryDtoColumns">
        c.category_seq, c.name, c.description, c.sort_order, c.is_active,
        c.created_at, c.updated_at, c.created_seq, c.updated_seq
    </sql>

    <!-- 검색 조건 -->
    <sql id="searchConditions">
        <where>
            <if test="search.hasKeyword()">
                AND (c.name LIKE CONCAT('%', #{search.keyword}, '%')
                     OR c.description LIKE CONCAT('%', #{search.keyword}, '%'))
            </if>
            <if test="search.hasStatus()">
                <choose>
                    <when test="search.status.name() == 'ACTIVE'">
                        AND c.is_active = true
                    </when>
                    <when test="search.status.name() == 'INACTIVE'">
                        AND c.is_active = false
                    </when>
                </choose>
            </if>
        </where>
    </sql>

    <!-- 정렬 -->
    <sql id="orderBy">
        ORDER BY c.sort_order ASC, c.created_at DESC
    </sql>

    <!-- 활성 카테고리 목록 조회 -->
    <select id="findAllActive" resultMap="categoryDtoResultMap">
        SELECT <include refid="categoryDtoColumns"/>
        FROM categories c
        WHERE c.is_active = true
        ORDER BY c.sort_order ASC
    </select>

    <!-- 활성 카테고리 + 선택된 카테고리 조회 -->
    <select id="findAllActiveOrSelected" resultMap="categoryDtoResultMap">
        SELECT <include refid="categoryDtoColumns"/>
        FROM categories c
        WHERE c.is_active = true
        <if test="selectedCategorySeq != null">
            OR c.category_seq = #{selectedCategorySeq}
        </if>
        ORDER BY c.sort_order ASC
    </select>

    <!-- 카테고리 검색 (페이징) -->
    <select id="findAll" resultMap="categoryDtoResultMap">
        SELECT <include refid="categoryDtoColumns"/>
        FROM categories c
        <include refid="searchConditions"/>
        <include refid="orderBy"/>
        LIMIT #{search.offset}, #{search.size}
    </select>

    <!-- 카테고리 검색 개수 -->
    <select id="count" resultType="int">
        SELECT COUNT(*)
        FROM categories c
        <include refid="searchConditions"/>
    </select>

    <!-- 카테고리 상세 조회 -->
    <select id="findBySeq" resultMap="categoryDtoResultMap">
        SELECT <include refid="categoryDtoColumns"/>
        FROM categories c
        WHERE c.category_seq = #{categorySeq}
    </select>

    <!-- 카테고리 등록 -->
    <insert id="insert" parameterType="io.goorm.board.dto.category.CategoryDto" useGeneratedKeys="true" keyProperty="category.categorySeq">
        INSERT INTO categories (
            name, description, sort_order, is_active,
            created_at, updated_at, created_seq, updated_seq
        ) VALUES (
            #{category.name}, #{category.description}, #{category.sortOrder}, #{category.isActive},
            NOW(), NOW(),
            #{category.createdSeq}, #{category.updatedSeq}
        )
    </insert>

    <!-- 카테고리 수정 -->
    <update id="update">
        UPDATE categories SET
            name = #{category.name},
            description = #{category.description},
            updated_at = NOW(),
            updated_seq = #{category.updatedSeq}
        WHERE category_seq = #{category.categorySeq}
    </update>

    <!-- 카테고리 활성화 -->
    <update id="activate">
        UPDATE categories SET
            is_active = true,
            updated_at = NOW()
        WHERE category_seq = #{categorySeq}
    </update>

    <!-- 카테고리 비활성화 -->
    <update id="deactivate">
        UPDATE categories SET
            is_active = false,
            updated_at = NOW()
        WHERE category_seq = #{categorySeq}
    </update>

    <!-- 최대 정렬 순서 조회 -->
    <select id="findMaxSortOrder" resultType="java.lang.Integer">
        SELECT MAX(sort_order)
        FROM categories
    </select>

    <!-- Excel용 전체 카테고리 조회 -->
    <select id="findAllForExcel" resultMap="categoryDtoResultMap">
        SELECT <include refid="categoryDtoColumns"/>
        FROM categories c
        <include refid="searchConditions"/>
        <include refid="orderBy"/>
    </select>

</mapper>